<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Kaazing.org - Kaazing.org Docs</title>
    <link rel="icon" href="/img/favicon.ico">

  <link href='http://fonts.googleapis.com/css?family=Muli:300,400' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/bootstrap.min.css">
  <link rel="stylesheet" href="../../assets/font-awesome-4.1.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="../../css/pygments.css">
  <link rel="stylesheet" href="../../css/main.css">
  <link rel="stylesheet" href="../../css/syntax.css">
  <link rel="stylesheet" href="../../css/doc.css">

  


<!-- +++++++++++++++Syntax Highlighter Calls++++++++++++++++ -->

<!-- Include required SyntaxHighlighter JS files -->
<script type="text/javascript" src="../../resources/xregexp.js"></script>
<script type="text/javascript" src="../../resources/shCore.js"></script>


<!--Include SyntaxHighlighter brushes. To test, using the JS brush -->
<script type="text/javascript" src="../../resources/shBrushJava.js"></script>
<script type="text/javascript" src="../../resources/shBrushAS3.js"></script>
<script type="text/javascript" src="../../resources/shBrushVb.js"></script>
<script type="text/javascript" src="../../resources/shBrushJScript.js"></script>
<script type="text/javascript" src="../../resources/shBrushCss.js"></script>
<script type="text/javascript" src="../../resources/shBrushPython.js"></script>
<script type="text/javascript" src="../../resources/shBrushXml.js"></script>

<!-- Include SyntaxHighlighter core style and Kaazing theme -->
<link href="../../resources/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../resources/shThemeKaazing.css" rel="stylesheet" type="text/css" />

<!-- Finally, call SyntaxHighlighter -->
<script type="text/javascript">
   SyntaxHighlighter.all()
</script>

<!-- +++++++++++++++END OF Syntax Highlighter Calls++++++++++++++++ -->
</head>

<body>

    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="../../index.html"><img id="kaazing-logo-header" src="../../img/Kaazing.png" alt="Kaazing.org"></img></a>
		</div>
		<div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav navbar-right">
				<li><a href="http://github.com/kaazing" target="_blank">GitHub</a></li>
				<li><a href="http://developer.kaazing.com/documentation/5.0/index.html">Documentation</a></li>
				<li><a href="http://kaazing.org/download">Download</a></li>
				<li><a href="http://kaazing.org/demos">Demos</a></li>
				<li><a href="http://kaazing.org/demos/quick-start">Quick Start</a></li>
				<li><a href="http://kaazing.org/blog">Blog</a></li>
				<li class="hidden-sm"><a href="http://kaazing.org/developer-subscription">Developer Subscription</a></li>
			</ul>
		</div><!--/.nav-collapse -->
	</div>
</nav>

<div id="diagnostic">
</div>


    <div class="container page-content text-left">

  <link rel="stylesheet" href="/css/doc.css">

<div class="container page-content text-left">
<h1>Use the Kaazing Gateway Flash AMQP Client Library</h1>
<p>In this procedure, you will learn how to use the Kaazing Gateway Flash AMQP Client Library and the supported APIs. The steps in this section show you how to set up your development environment and add perform the following coding steps:</p>
<ol>
        <li><a href="#setup_flex_dev_env">Set up your Flex development environment</a></li>
        <li><a href="#using_lib_flex">Review the common Flash AMQP programming steps</a></li>
        <li><a href="#create_object">Create the AmqpClient object</a></li>
        <li><a href="#connect_broker">Connect to an AMQP broker</a></li>
        <li><a href="#create_channels">Create channels</a></li>
        <li><a href="#creating_exchanges">Declare an exchange</a></li>
        <li><a href="#creating_queues">Declare a queue</a></li>
        <li><a href="#binding_queues">Bind an exchange to a queue</a></li>
        <li><a href="#publishing_messages">Publish messages</a></li>
        <li><a href="#consuming_messages">Consume messages</a></li>
        <li><a href="#using_transactions">Use transactions</a></li>
        <li><a href="#control_flow">Control message flow</a></li>
        <li><a href="#exception_handling">Handle exceptions</a></li>
        <li><a href="#run_client">Compile and run the Flex application</a></li>
</ol>


<h2><a name="_"></a>Before You Begin</h2>
<p>This procedure is part of <a href="o_dev_flash.html">Checklist: How to Build Flash Clients Using Kaazing Gateway</a>:</p>

<p>
        <ol>
        <li><a href="o_dev_flash.html#keglibs">Overview of the Kaazing Gateway AMQP Client Library</a></li>
        <li><strong>Use the Kaazing Gateway Flash AMQP Client Library</strong></li>
        <li><a href="p_dev_flash_secure.html">Secure Your Flash AMQP Client</a></li>
        </ol>
</p>

<p><span class="note"><b>Note:</b> Learn about supported browsers, operating systems, and platform versions in the <a href="../../release-notes.html">Release Notes</a>.</span></p>  

<h2>To Use the Kaazing Gateway Flash AMQP Client Library</h2>
<p>
<ol>
<li><a name="setup_flex_dev_env" id="setup_flex_dev_env"></a><p>Set up your Flex development environment.</p>
        <ol type="a">
                <li>To develop a Flex application, you must download the Adobe Flex 3 SDK. The Adobe Flex 3 SDK can be used to compile ActionScript source files into a SWF file, which is the target application. You can download the Adobe Flex 3 SDK from the Adobe download site and install it into your local drive.</li>
                <li>To use the Kaazing Gateway AMQP client libraries for Flex, you must add a reference to the libraries located in the <code>com.kaazing.net.ws.amqp.client.swc</code> and <code>com.kaazing.gateway.client.swc</code> to your Flash application. The files are in the directory <span class="uri"><em>GATEWAY_HOME</em>/lib/client/flash</span>.</li>
    <li><p><a name="config_gateway" id="config_gateway"></a>Configure Kaazing Gateway to connect to an AMQP broker.</p>
                        <p><span class="note"><b>Note:</b> If you have Kaazing Gateway running on <span class="code_inline">localhost</span> and if you have an AMQP broker running on <span class="code_inline">localhost</span> at the default AMQP port <span class="code_inline">5672</span>, you do not have to configure anything to see the AMQP demos and the interactive AMQP guide.</span></p>

                        <p>The following is an example of the default configuration element for the AMQP service in the Kaazing Gateway bundle, as specified in the configuration file <span class="code_inline"><em>GATEWAY_HOME</em>/conf/gateway-config.xml</span>:</p>

                        <pre class="auto-links: false; brush: xml; toolbar: false;">
                        &lt;!-- Proxy service to AMQP server --&gt;
                        &lt;service&gt;
                                &lt;accept&gt;ws://localhost:8001/amqp&lt;/accept&gt;
                                &lt;accept&gt;wss://localhost:9000/amqp&lt;/accept&gt;
                                &lt;connect&gt;tcp://localhost:5672&lt;/connect&gt;

                                &lt;type&gt;amqp.proxy&lt;/type&gt;

                                &lt;cross-site-constraint&gt;
                                        &lt;allow-origin&gt;http://localhost:8001&lt;/allow-origin&gt;
                                &lt;/cross-site-constraint&gt;
                                &lt;cross-site-constraint&gt;
                                        &lt;allow-origin&gt;https://localhost:9000&lt;/allow-origin&gt;
                                &lt;/cross-site-constraint&gt;
                        &lt;/service&gt;</pre>

                        <p>In this case, the service is configured to accept WebSocket AMQP requests from the browser at <span class="code_inline">ws://localhost:8001/amqp</span> and securely at <span class="code_inline">wss://localhost:9000/amqp</span> and proxy those requests to a locally installed AMQP broker (<span class="code_inline">localhost</span>) at port <span class="code_inline">5672</span>.</p>

                        <p>To configure the Gateway to accept WebSocket requests at another URL or to connect to a different AMQP broker, you can edit <span class="code_inline"><em>GATEWAY_HOME</em>/conf/gateway-config.xml</span>, update the values for the <span class="code_inline">accept</span> elements, change the <span class="code_inline">connect</span> property, and restart the Gateway. For example, the following  configuration configures the Gateway to accept WebSocket AMQP requests at <span class="code_inline">ws://www.example.com:80/amqp</span> and proxy those requests to an AMQP broker (<span class="code_inline">amqp.example.com</span>) on port <span class="code_inline">5672</span>.</p>

                        <pre class="auto-links: false; brush: xml; toolbar: false;">
                        &lt;!-- Proxy service to AMQP server --&gt;
                        &lt;service&gt;
                                &lt;accept&gt;ws://www.example.com:80/amqp&lt;/accept&gt;
                                &lt;connect&gt;tcp://amqp.example.com:5672&lt;/connect&gt;

                                &lt;type&gt;amqp.proxy&lt;/type&gt;
                        &lt;/service&gt;</pre>
                </li>
        </ol>
        
</li>

<li><a name="using_lib_flex"></a><p>Review the common Flash AMQP programming steps.</p>
        <p>Now that you have set up your environment to develop Flash applications using the Gateway's AMQP client library, you can start creating your application. You can either build a single application that both publishes and consumes messages, or create two different applications to handle each action. The demo located at <a href="http://localhost:8001/demo/amqp/flash/?d=amqp-flash">http://localhost:8001/demo/amqp/flash/?d=amqp-flash</a> shows a single application that handles both actions. You can view the source code for this demo in <span class="code_inline"><em>GATEWAY_HOME</em>/demo/flash/src/amqp/amqpbasic.mxml</span>. Refer to the <a href="../apidoc/client/flash/amqp/index.html">AMQP Client ActionScript API</a> documentation for the complete list of all the AMQP command and callback functions.</p>
        <p>The common Flash AMQP programming steps are:</p>
        <ol type="a">
                <li><a href="#create_object">Create the AmqpClient object</a></li>
                <li><a href="#connect_broker">Connect to an AMQP broker</a></li>
                <li><a href="#create_channels">Create channels</a></li>
                <li><a href="#creating_exchanges">Declare an exchange</a></li>
                <li><a href="#creating_queues">Declare a queue</a></li>
                <li><a href="#binding_queues">Bind an exchange to a queue</a></li>
                <li><a href="#publishing_messages">Publish messages</a></li>
                <li><a href="#consuming_messages">Consume messages</a></li>
                <li><a href="#using_transactions">Use transactions</a></li>
                <li><a href="#control_flow">Control message flow</a></li>
                <li><a href="#exception_handling">Handle exceptions</a></li>
                <li><a href="#run_client">Compile and run the Flex application</a></li>
        </ol>
</li>

<li><a name="create_object" id="create_object"></a><p>Create the AmqpClient object.</p>
<p>First, let's create an AmqpClient client object. Before you create the client object, add the following import statements in your application's <span class="code_inline">.MXML</span> file:</p>
<pre class="brush: js; toolbar: false;">
import com.kaazing.gateway.client.Charset;
import com.kaazing.gateway.client.ByteBuffer;
import com.kaazing.gateway.amqp.client.flash.AmqpArguments;
import com.kaazing.gateway.amqp.client.flash.AmqpEvent;
import com.kaazing.gateway.amqp.client.flash.AmqpChannel;
import com.kaazing.gateway.amqp.client.flash.AmqpClient;
</pre>
<p>Next, declare a variable and create an instance of the <span class="code_inline">AmqpClient</span> object as shown in the following example.</p>
<pre class="auto-links: false; brush: js; toolbar: false;">private var client:AmqpClient = new AmqpClient();</pre>

<p>Now that you have created an instance of the AmqpClient object, you can use the AMQP protocol commands. To handle open and close events, add two event handlers: one for the <span class="code_inline">OPEN</span> event and one for the <span class="code_inline">CLOSE</span> event, as shown in the following example.<BR>
</p>
<pre class="brush: js; toolbar: false;">
client.addEventListener(AmqpEvent.OPEN, openHandler);
client.addEventListener(AmqpEvent.CLOSE, closeHandler);
</pre>
<p>Refer to the <a href="../apidoc/client/flash/amqp/index.html">AMQP Client ActionScript API</a> documentation for the complete list of all the AMQP command and callback functions.</p>
</li>

<li><a name="connect_broker" id="connect_broker"></a><p>Connect to an AMQP broker.</p>
  <p>Next, you must connect and log in to an AMQP broker. The client generally manages all of its communication on a single connection to an AMQP broker. You establish a connection to an AMQP broker by passing in the broker address, a user name and password, the AMQP version you want to use, and, optionally, a virtual host name (the name of a collection of exchanges and queues hosted on independent server domains). These parameters are passed in when you call the <span class="code_inline">connect</span> method as shown in the following example.</p>
        <pre class="auto-links: false; brush: js; toolbar: false;"> client.connect(location, virtualHost, {username:user, password:pwd});</pre>
        <p class="note"><strong>Note</strong>: The Gateway supports AMQP version 0-9-1.</p>
</li>

<li><a name="create_channels" id="create_channels"></a><p>Create Channels</p>
  <p>Once a connection to an AMQP broker has been established, the client must create a channel to communicate to the broker. A channel is a bi-directional connection between an AMQP client and an AMQP broker. AMQP is multi-channeled, which means that channels are multiplexed over a single network socket connection. Channels are light-weight and consume little resources, and therefore used in AMQP's exception handling mechanism&mdash;channels are closed when an exception occurs.</p>
        
        <p>First, declare variables for two channels (one for publishing to an exchange and one for consuming from a queue) as shown in the following example.</p>
<pre class="brush: js; toolbar: false;">
private var publishChannel:AmqpChannel;
private var consumeChannel:AmqpChannel;</pre>

<p>Then, create the channels as shown in the following example. </p>
<pre class="brush: js; toolbar: false;">
private function openHandler(e:AmqpEvent):void {
publishChannel = client.openChannel();
consumeChannel = client.openChannel();
}</pre>

<p>Once you have created the channels, you can add event handlers for various channel events as shown in the following example.</p>
<pre class="brush: js; toolbar: false;">
publishChannel.addEventListener(AmqpEvent.DECLAREEXCHANGE,
    function(e:AmqpEvent):void {log(&quot;Exchange declared &quot;);});
publishChannel.addEventListener(AmqpEvent.BINDQUEUE,
    function(e:AmqpEvent):void {log(&quot;Bound queue and exchange&quot;);});
publishChannel.addEventListener(AmqpEvent.CLOSE, closePublishChannelHandler);


consumeChannel.addEventListener(AmqpEvent.DECLAREQUEUE,
    function(e:AmqpEvent):void {log(&quot;Queue declared &quot;);});
consumeChannel.addEventListener(AmqpEvent.SUBSCRIBE,
    function(e:AmqpEvent):void {log(&quot;Subscribed to the queue &quot;);});
consumeChannel.addEventListener(AmqpEvent.CLOSE,
    function(e:AmqpEvent):void {log(&quot;Channel closed &quot;);});
consumeChannel.addEventListener(AmqpEvent.FLOW,
    function(e:AmqpEvent):void {log(&quot;Flow event&quot;);});
consumeChannel.addEventListener(AmqpEvent.MESSAGE, messageHandler);</pre>

<p>In this example, each of the event handlers has an associated function (either anonymous or named) that processes the AMQP event. Refer to the <a href="../apidoc/client/flash/amqp/index.html">AmqpEvent ActionScript API documentation</a> for more information about channel events.</p></li>

<li><a name="creating_exchanges" id="creating_exchanges"></a><p>Declare an Exchange</p>
  <p>AMQP messages are published to exchanges. Messages contain a <em>routing key</em> that contains the information about the message's destination. The exchange accepts messages and their routing keys and delivers them to a message queue. You can think of an exchange as an electronic mailman that delivers the messages to a mailbox (the queue) based on the address on the message's envelope (the routing key). Exchanges do not store messages.</p>
  <p>AMQP defines different exchange types. Some of these exchange types (Direct, Fanout, and Topic) must be supported by all AMQP brokers while others (Headers and System) are optional. AMQP brokers can also support custom exchange types. The following are the different types of exchanges:</p>
        <ul class="arrow-2">
                <li><strong>Direct</strong>: Messages  are sent only to a queue that is bound with a binding key that matches the message's routing key.</li>
                <li><strong>Fanout</strong>: Messages are  sent to every queue that is bound to the exchange.</li>
                <li><strong>Topic</strong>: Messages are sent to a queue based on categorical binding keys and wildcards.</li>
                <li><strong>Headers</strong>: Messages are sent to a queue based on their header property values.</li>
                <li><strong>System</strong>: Messages are sent to system services.</li>
        </ul>
        
  <p>Exchanges can be <em>durable</em>, meaning that the exchange survives broker shutdown and must be deleted manually or <em>non-durable</em> (temporary) meaning that the exchange lasts only until the broker is shut down. Finally, to check if an exchange exists on the AMQP broker (without actually creating it), you can create a <em>passive</em> exchange. The following example shows how you can create a direct exchange on the publish channel:</p>
        <pre class="auto-links: false; brush: js; toolbar: false;">publishChannel.declareExchange(exchangeName, "direct", passive, durable, noWait, null);</pre>
        
  <p><span class="note"><strong>Note</strong>: In this example, the arguments <span class="code_inline">passive</span>, <span class="code_inline">durable</span>, and <span class="code_inline">noWait</span> represent boolean values. Also note that no custom parameters are passed in.</span> </p>
  <p>After the exchange is created successfully, a <span class="code_inline">declareexchange</span> event is raised, which calls the previously registered event handler.</p></li>

<li><a name="creating_queues" id="creating_queues"></a><p>Declare a queue.</p>
  <p>AMQP messages are consumed from queues. You can think of a queue as a mailbox; messages addressed to a particular address (the routing key) are placed in the mailbox for the consumer to pick up. If multiple consumers are bound to a single queue, only one of the consumers receives the message (the one that picked up the mail).</p>
  <p>To check if a queue exists on the AMQP broker (without creating it), you can create a <em>passive</em> queue. Additionally, queues can be marked <em>exclusive</em>, meaning that they are tied to a specific connection. If a queue is marked exclusive, it is deleted when the connection on which it was created is closed.</p>
  <p>Queues can be <em>durable</em>, meaning that the queue survives broker shutdown and must be deleted manually or <em>non-durable</em> (temporary) meaning that the queue lasts only until the broker is shut down. Queues can also be marked <em>auto delete</em>, meaning that the queue is deleted  automatically when it is no longer in use. The following example shows how you can create a  queue on the consume channel:</p>
        <pre class="auto-links: false; brush: js; toolbar: false;">consumeChannel.declareQueue(queueName, passive, durable, exclusive, autoDelete, noWait, null);</pre>
        
  <p><span class="note"><strong>Note</strong>: In this example, the arguments <span class="code_inline">passive</span>, <span class="code_inline">durable</span>, <span class="code_inline">exclusive</span>, <span class="code_inline">autoDelete</span>, and <span class="code_inline">noWait</span> represent boolean values. Also note that no custom parameters are passed in.</span> </p>
  <p>After the queue is created successfully, a <span class="code_inline">declarequeue</span> event is raised, which calls the event handler registered previously.</p></li>

<li><a name="binding_queues" id="binding_queues"></a><p>Bind an exchange to a queue.</p>
  <p>Once you have created an exchange and a queue in AMQP, you must bind&mdash;or map&mdash;one to the other so that messages published to a specific exchange are delivered to a particular queue. You bind a queue to an exchange with a routing key as shown in the following example.</p>
<pre class="auto-links: false; brush: js; toolbar: false;">publishChannel.bindQueue(queueName, exchangeName, routingKey, noWait, null);</pre>   
<p>After the exchange is bound to the queue successfully, a <span class="code_inline">binddqueue</span> event is raised, which calls the event handler registered previously.</p>
</li>

<li><a name="publishing_messages" id="publishing_messages"></a><p>Publish messages.</p>
  <p>Messages are published to exchanges. The established binding rules (routing keys) then determine to which queue a message is delivered. Messages have content that consists of two parts:</p>
        <ol>
                <li><strong>Content Header</strong>&mdash;A set of  properties that describes the message</li>
                <li><strong>Content Body</strong>&mdash;A blob of binary data</li>
        </ol>
  <p>Additionally, messages can be marked <em>mandatory</em> to send a notification to the publisher in case a message cannot be delivered to a queue. You can also mark a message <em>immediate</em> so that it is returned to the sender if the message cannot be routed to a queue consumer immediately. The following example shows how the content body of a message is added to a buffer (AMQP uses a binary message format) and published to an exchange using the publish channel:</p>
<pre class="brush: js; toolbar: false; highlight:[9,10,11,13,21,26];">
public function publishSendHandler(e:Event):void { 
        if (message.text == null || message.text.length == 0)
        {
            Alert.show("Enter valid text for a message", "AMQP message invalid", Alert.OK);
            return;
        } 

        var body:ByteBuffer = new ByteBuffer();
        body.putString(message.text, Charset.UTF8);
        body.flip();

        var amqpProperties:AmqpProperties = new AmqpProperties();
        amqpProperties.contentType = AmqpProperties.TEXT_PLAIN;
        amqpProperties.priority = 6;
        amqpProperties.deliveryMode = 1;
        amqpProperties.timestamp = new Date();
        amqpProperties.contentEncoding = "utf-8";
        amqpProperties.messageId = "abcdxyz1234pqr";
        amqpProperties.correlationId = "23456";
        amqpProperties.userId = username.text;
        var customHeaders:AmqpArguments = new AmqpArguments();
        customHeaders.addInteger("KZNG_AMQP_KEY1", 100);
        customHeaders.addLongString("KZNG_AMQP_KEY2", "Custom Header Value");
        amqpProperties.headers = customHeaders;
        exchangeName = consumeExchange.text;
        publishChannel.publishBasic(body, amqpProperties, exchangeName, "broadcastkey", false, false);
        log(amqpProperties.toString());
        log("Published Message Properties:");
        log("MESSAGE PUBLISHED: " + message.text);
}
</pre>

<p>A custom parameter is passed in for the message. The message text entered by the user is stored in a variable and converted to binary (<span class="code_inline">body.putString(message.text, Charset.UTF8);</span>), and then sent to the exchange specified by the user (<span class="code_inline">exchangeName</span>). Also note that the last two arguments use boolean values for <span class="code_inline">mandatory</span> and <span class="code_inline">immediate</span>.</p>

<p>The <span class="code_inline">AmqpProperties</span> class defines pre-defined properties as per AMQP 0-9-1 spec and provides type-safe getters and setters for those pre-defined properties. The value of AMQP 0-9-1's standard "headers" property is of type <a href="../apidoc/client/flash/amqp/com/kaazing/gateway/amqp/client/AmqpArguments.html">AmqpArguments</a>. The Kaazing Gateway AMQP implementation uses AmqpArguments to encode the table. Similarly, the Kaazing Gateway AMQP implementation decodes the table and constructs an instance of AmqpArguments.</p>

<span class="note"><b>Notes:</b><br>
 <ul class="arrow-2">
   <li>The arguments <span class="code_inline">mandatory</span> and <span class="code_inline">immediate</span> use boolean values. Also note that no custom parameters are passed in.</li>
         <li>The timestamp property (not shown in this example), will only handle 6-bytes (or 48-bit) timestamp values.</li> 
         <li>The username set with the <span class="code_inline">userId</span> method must match the user that is currently authenticated with the AMQP broker. If they do not match you will see the following error: <br><span class="code_inline">PRECONDITION_FAILED - user_id property set to '&lt;<em>name</em>&gt;' but authenticated user was '&lt;<em>name</em>&gt;'</span></li>
 </ul>
</span>

<li><a name="consuming_messages"></a><p>Consume messages.</p>
  <p>Once messages are published, they can be consumed from a queue. A variety of options can be applied to  messages in a queue. For example, publishers can choose to require acknowledgement (<em>ack</em>) of messages so that messages can be redelivered in the case of a delivery failure. If the queue is set to <em>exclusive</em>, it is scoped to just the current connection and deleted when the connection on which it was established is closed. Additionally, you can use the <em>no local</em> setting to notify the broker <em>not</em> to send messages to the connection on which the messages were published. The following example shows how you can consume messages from a queue on the consume channel:</p>
<pre class="auto-links: false; brush: js; toolbar: false;">
consumeChannel.declareQueue(queueName, false, false, false, false, false)
        .bindQueue(queueName, exchangeName, routingKey, false)
        .consumeBasic(queueName, myConsumerTag, false, false, false, false);
</pre>

<p><span class="note"><strong>Note</strong>: In this example, the arguments <span class="code_inline">noLocal</span>, <span class="code_inline">noAck</span>, <span class="code_inline">noWait</span>, and <span class="code_inline">exclusive</span> represent boolean values.</span></p>
  <p>After the <span class="code_inline">consumeBasic</span> method is successful, a <span class="code_inline">subscribe</span> event is raised, which calls the previously registered event handler. The AMQP broker can then start delivering messages to the client and these messages raise the <span class="code_inline">message</span> event, which calls the corresponding event handler. The following example shows how the <span class="code_inline">messageHandler</span> function retrieves information from the <span class="code_inline">AmqpEvent</span> object:</p>

<pre class="brush: js; toolbar: false;">
private function messageHandler(e:AmqpEvent):void {
        var body:String = e.body.getString(Charset.UTF8);
        if (e.amqpProperties != null) {
                log(&quot;Consumed Message Properties:&quot;);
                log(e.amqpProperties.toString());
        }
        log(&quot;MESSAGE CONSUMED: &quot; + body);

        // Acknowledge the message as we passed in a &#x27;false&#x27; for
        // noAck in AmqpChannel.consumeBasic() call. If the
        // message is not acknowledged, the broker will keep
        // holding the message. And, as more and more messages
        // are held by the broker, it will eventually result in 
        // an OutOfMemoryError.                
        var channel:AmqpChannel = e.target as AmqpChannel;
        var dt:Number = Number(e.args.deliveryTag);
        setTimeout(function():void {
                channel.ackBasic(dt, true);
        }, 0);
}</pre>

<p>Here you can see how the properties are retrieved using AmqpProperties methods.</p>

<h5><a name="Message_Acknowledgement"></a>Message Acknowledgement</h5>

<p>The Boolean parameter <code>noAck</code> is optional with the default value of <code>true</code>. If <code>noAck</code> is <code>true</code>, the AMQP broker will not expect any acknowledgement from the client before discarding the message. If <code>noAck</code> is <code>false</code>, then the AMQP broker will expect an acknowledgement before discarding the message. If <code>noAck</code> is specified to be <code>false</code>, then you must explicitly acknowledge the received message using <code>AmqpChannel</code> <code>ackBasic()</code>.</p>

<p>In the AMQP demo code in this procedure, message acknowledgement is being performed because <code>false</code> was passed in for <code>noAck</code> in <code>consumeBasic()</code>. If the client acknowledges a message <strong>and</strong> <code>noAck</code> is <code>true</code> (the default setting), then the AMQP message broker will close the channel.</p>

</li>

<li><a name="using_transactions"></a><p>Use transactions.</p>
  <p>AMQP supports transactional messaging, through <em>server local transactions</em>. In a transaction, the server only publishes a set of messages as one unit when the client commits the transaction. Transactions only apply to message publishing and not to the consumption of the messages.</p>
  <p><span class="note"><strong>Note</strong>: Once you commit or roll back a transaction on a channel, a new transaction is started automatically. For this reason you must commit all future messages you want to publish on that channel or create a new, non-transactional channel to publish messages on.</span></p>
  <p>The following transaction-related methods can be used to work select (start), commit, and rollback a transaction:</p>
<pre class="brush: js; toolbar: false;">
txnPublishChannel.selectTx();
txnPublishChannel.commitTx();
txnPublishChannel.rollbackTx();</pre>

<p>After the transaction is selected successfully, committed, or rolled back, the corresponding events (<span class="code_inline">selecttransaction</span>, <span class="code_inline">committransaction</span>, <span class="code_inline">rollbacktransaction</span>) are raised. These events call previously registered event handlers:

<pre class="auto-links: false; brush: js; toolbar: false;">
private function txnPublishChannelOpenHandler(e:AmqpEvent):void {
        txnPublishChannel.declareExchange(txnExchangeName, "fanout", false, false, false);
        txnPublishChannel.addEventListener(AmqpEvent.SELECTTRANSACTION, 
                function(e:AmqpEvent):void {
                                log("TXN SELECTED/STARTED"); updateTransactionButtons(true, true);});
        txnPublishChannel.addEventListener(AmqpEvent.COMMITTRANSACTION, 
                function(e:AmqpEvent):void {
                                log("TXN COMMITTED"); updateTransactionButtons(false, true);});
        txnPublishChannel.addEventListener(AmqpEvent.ROLLBACKTRANSACTION, 
                function(e:AmqpEvent):void {
                                log("TXN ROLLEDBACK"); updateTransactionButtons(false, true);});
}</pre>

</p>

<p>To see an example of transactions in an application, see the sample demo code in <span class="code_inline"><em>GATEWAY_HOME</em>/demo/flash/src/amqp/amqpbasic.mxml</span>.</p>

</li>

<li><a name="control_flow"></a><p>Control message flow.</p>
        <p>You can use flow control in AMQP to temporarily&mdash;or permanently&mdash;halt the flow of messages on a channel from a queue to a consumer. If you turn the message flow off, no messages are sent to the consumer. The following example shows how you can turn the flow of messages on a channel off and back on:</p>
<pre class="brush: js; toolbar: false;">
consumeChannel.flowChannel(false);
consumeChannel.flowChannel(true);</pre>
<p>After the flow on a channel is halted or resumed successfully, a <span class="code_inline">flow</span> event is raised, which calls the event handler registered previously.</p></li>

<li><a name="exception_handling"></a><p>Handle exceptions.</p>
  <p>Channels do not consume large resources, and therefore used in AMQP's exception handling mechanism&mdash;channels are closed when an exception occurs. In this example, the previously registered event handler for the <span class="code_inline">CLOSE</span> event calls the <span class="code_inline">closePublishChannelHandler</span> function when the channel closes and the function receives an <span class="code_inline">AmqpEvent</span> object, which contains detailed information about the exception. The following shows an example of how this information can be used.</p>
<pre class="brush: js; toolbar: false;">
private function closePublishChannelHandler(e:AmqpEvent):void {
        var body:String = e.frame.body.getString(Charset.UTF8);
        log("Channel Closed: " + body);
}</pre></li>

<li><a name="run_client" id="run_client"></a><p>Compile and run the Flex application.</p>
        <p>Once you are finished coding the client (typically, an <span class="code_inline">.MXML</span> file), you must use the Adobe Flex 3 SDK from Adobe to compile your Flex client. Ensure that your library path points to the Kaazing Gateway Flex library <span class="code_inline">.SWC</span> file <span class="code_inline">kaazing-websocket-gateway-client-<em>release-version</em>.swc</span>. This <span class="code_inline">.SWC</span> file can be found in the Kaazing Gateway bundle in the directory <span class="code_inline"><em>GATEWAY_HOME</em>/lib/client/flex</span>. Once you have compiled a SWF file, you can  execute this SWF file from the flash player or use a Web page to invoke it. For example, you can host it in the web directory <span class="code_inline"><em>GATEWAY_HOME</em>/web</span>.</p></li>
</ol>
</p>

<h2><a name="other_coding_styles"></a>Other Coding Styles</h2>
<p>In this topic, you have used an <em>event</em> programming style. You can also use a <em>continuation-passing</em> programming style. The following example shows how you can declare an exchange using the continuation-passing programming style:</p>
<pre class="auto-links: false; brush: js; toolbar: false;">
publishChannel.declareExchange(txtExchange, &quot;direct&quot;, passive, durable, 
        noWait, null, declareExchangeHandlerContinuation, errorHandlerContinuation);</pre>
<p>You can also combine the two programming styles.</p>

<h2><a name="_"></a>Next Step</h2>
<p><a href="p_dev_flash_secure.html">Secure Your Flash AMQP Client</a></p>

                  </section>
                </article>

            </div> <!-- #main -->
        </div> <!-- #main-container -->

    <footer>
  <div class="container">

    <div class="row text-center social-media">
      <a href="https://github.com/kaazing"><i class="fa fa-github" data-toggle="tooltip" data-placement="top" title="Github"></i></a>
      <a href="https://www.facebook.com/kaazing"><i class="fa fa-facebook" data-toggle="tooltip" data-placement="top" title="Facebook"></i></a>&nbsp;
      <a href="https://twitter.com/kaazing"><i class="fa fa-twitter" data-toggle="tooltip" data-placement="top" title="Twitter"></i></a>&nbsp;
      <a href="https://plus.google.com/+KaazingHome"><i class="fa fa-google-plus" data-toggle="tooltip" data-placement="top" title="Google Plus"></i></a>&nbsp;
      <a href="https://www.youtube.com/user/KaazingTV"><i class="fa fa-youtube" data-toggle="tooltip" data-placement="top" title="Youtube"></i></a>&nbsp;
      <a href="https://www.linkedin.com/company/kaazing-corporation"><i class="fa fa-linkedin" data-toggle="tooltip" data-placement="top" title="Linkedin"></i></a>&nbsp;
    </div>

    <div class="row copyright">
      <div class="col-xs-12 col-sm-5 text-left">
        &copy; 2007-2015 Kaazing Corporation
      </div>
      <div class="col-xs-12 col-sm-7 license">
        This website is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">Creative Commons BY-NC-SA</a>
      </div>
    </div>

  </div>
</footer>

<!-- start:javascript for this page -->










<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1771436-3', 'auto');
  ga('send', 'pageview');
  </script
  <!-- end:javascript for this page -->


</body>
</html>
